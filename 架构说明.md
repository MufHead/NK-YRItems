# YRItems æ¶æ„è¯´æ˜

## æ€»ä½“æ¶æ„

YRItems é‡‡ç”¨ **Javaåº•å±‚é’©å­ + JavaScriptä¸šåŠ¡é€»è¾‘** çš„åˆ†å±‚æ¶æ„ã€‚

### è®¾è®¡ç†å¿µ

- **Javaå±‚**ï¼šæä¾›åº•å±‚é’©å­å’ŒåŸºç¡€è®¾æ–½ï¼Œå¤„ç†æ€§èƒ½æ•æ„Ÿçš„æ“ä½œ
- **JavaScriptå±‚**ï¼šå®ç°ä¸šåŠ¡é€»è¾‘ï¼Œå®Œå…¨æ§åˆ¶æ˜¾ç¤ºè§„åˆ™å’Œæ ·å¼

## åˆ†å±‚è¯¦è§£

### Javaå±‚ï¼ˆåŸºç¡€è®¾æ–½ï¼‰

#### 1. ASM å­—èŠ‚ç æ³¨å…¥ (BinaryStreamHook + BinaryStreamTransformer)

**èŒè´£**ï¼š
- æ³¨å…¥ `BinaryStream.getSlot()` æ–¹æ³•
- åœ¨ç‰©å“ååºåˆ—åŒ–æ—¶è‡ªåŠ¨æ¸…ç† `_DynamicLore` æ ‡è®°
- **ä¸æ¶‰åŠä»»ä½•æ˜¾ç¤ºé€»è¾‘**

**ä»£ç ä½ç½®**ï¼š
- [BinaryStreamHook.java](src/main/java/com/yirankuma/yritems/hook/BinaryStreamHook.java)
- [BinaryStreamTransformer.java](src/main/java/com/yirankuma/yritems/asm/BinaryStreamTransformer.java)

**ä¸ºä»€ä¹ˆç”¨ASM**ï¼š
- MOTåä½œå¼Šéœ€è¦åœ¨æ•°æ®åŒ…å±‚é¢å¤„ç†
- JavaScriptæ— æ³•æ“ä½œå­—èŠ‚ç 
- æ€§èƒ½è¦æ±‚é«˜ï¼ˆæ¯ä¸ªç‰©å“åºåˆ—åŒ–éƒ½ä¼šè°ƒç”¨ï¼‰

#### 2. æ•°æ®åŒ…ç›‘å¬å™¨ (PacketReceiveListener)

**èŒè´£**ï¼š
- ç›‘å¬ `MobEquipmentPacket`ï¼ˆæ§½ä½åˆ‡æ¢ï¼‰
- å¼ºåˆ¶åŒæ­¥ `heldItemIndex`ï¼ˆä¿®å¤ `/yritems nbt` é—®é¢˜ï¼‰
- è°ƒç”¨ `BinaryStreamHook.removeDynamicLoreIfMarked()`

**ä»£ç ä½ç½®**ï¼š
- [PacketReceiveListener.java](src/main/java/com/yirankuma/yritems/listener/PacketReceiveListener.java)

#### 3. è„šæœ¬å¼•æ“ (ItemsScriptEngineManager)

**èŒè´£**ï¼š
- åŠ è½½å’Œç®¡ç†JavaScriptè„šæœ¬
- è§£æ `@Event` æ³¨è§£
- æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨åˆ° Nukkit
- æä¾› JS â†” Java äº’æ“ä½œ

**ä»£ç ä½ç½®**ï¼š
- [ItemsScriptEngineManager.java](src/main/java/com/yirankuma/yritems/script/ItemsScriptEngineManager.java)
- [DynamicListener.java](src/main/java/com/yirankuma/yritems/script/ItemsScriptEngineManager.java#L390)

**æ”¯æŒçš„åŠŸèƒ½**ï¼š
```javascript
// @Event æ³¨è§£è¯­æ³•
// @Event(eventName = "cn.nukkit.event.server.DataPacketSendEvent", priority="HIGH")
function onDataPacketSend(event) {
    // äº‹ä»¶å¤„ç†é€»è¾‘
}
```

### JavaScriptå±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

#### DynamicLore.js - åŠ¨æ€Loreç”Ÿæˆ

**å®Œå…¨æ§åˆ¶**ï¼š
- âœ… å±æ€§æ˜¾ç¤ºè§„åˆ™ï¼ˆå“ªäº›å±æ€§è¦æ˜¾ç¤ºï¼‰
- âœ… å±æ€§è®¡ç®—è§„åˆ™ï¼ˆå¦‚ä½•ç´¯åŠ  Damage + ExtraDamageï¼‰
- âœ… Loreæ ·å¼ï¼ˆé¢œè‰²ã€æ ¼å¼ã€é¡ºåºï¼‰
- âœ… ç¼“å­˜ç­–ç•¥
- âœ… æ€§èƒ½ä¼˜åŒ–

**ä»£ç ç»“æ„**ï¼š

```javascript
// 1. é…ç½®åŒº
var DYNAMIC_LORE_ENABLED = true;
var ATTRIBUTE_RULES = [...];  // å±æ€§è§„åˆ™æ•°ç»„

// 2. å·¥å…·å‡½æ•°
function nbtToObject(nbt) { ... }
function calculateAttributeValue(attr, rule) { ... }
function formatAttributeValue(value, rule) { ... }

// 3. æ ¸å¿ƒæ¸²æŸ“é€»è¾‘
function renderDynamicLore(nbtData) { ... }
function processItem(item) { ... }

// 4. äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡ @Event æ³¨è§£æ³¨å†Œï¼‰
// @Event(eventName = "cn.nukkit.event.server.DataPacketSendEvent", priority="HIGH")
function onDataPacketSend(event) { ... }
```

## æ•°æ®æµ

### ç‰©å“åˆ›å»º â†’ å‘é€ç»™å®¢æˆ·ç«¯

```
ItemData.toItem()
    â†“
æœåŠ¡å™¨ç«¯ç‰©å“: { YRAttributes, Lore }
    â†“
DataPacketSendEvent (JavaScriptç›‘å¬)
    â†“
DynamicLore.js::onDataPacketSend()
    â†“
cloneç‰©å“ â†’ æ·»åŠ  _DynamicLore æ ‡è®° â†’ å‘é€
```

### å®¢æˆ·ç«¯æ“ä½œ â†’ å‘å›æœåŠ¡å™¨

```
å®¢æˆ·ç«¯æ“ä½œç‰©å“
    â†“
InventoryTransactionPacket
    â†“
BinaryStream.getSlot() [ASMæ³¨å…¥]
    â†“
BinaryStreamHook.removeDynamicLoreIfMarked()
    â†“
ç§»é™¤ _DynamicLore å’Œ Lore
    â†“
MOTéªŒè¯é€šè¿‡ âœ…
```

## æ‰©å±•æ€§ç¤ºä¾‹

### æ·»åŠ æ–°çš„å±æ€§æ˜¾ç¤ºè§„åˆ™

ç¼–è¾‘ `Scripts/DynamicLore.js`ï¼š

```javascript
var ATTRIBUTE_RULES = [
    // ç°æœ‰è§„åˆ™...

    // æ·»åŠ æ–°å±æ€§ï¼šç”Ÿå‘½å·å–
    {
        displayName: "ç”Ÿå‘½å·å–",
        color: "Â§c",
        baseKey: "LifeSteal",              // åŸºç¡€å€¼
        extraKeys: ["ExtraLifeSteal"],      // é¢å¤–å€¼
        suffix: "%"
    },

    // æ·»åŠ æ–°å±æ€§ï¼šå†·å´ç¼©å‡ï¼ˆå¸¦è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼‰
    {
        displayName: "å†·å´ç¼©å‡",
        color: "Â§b",
        baseKey: "CooldownReduction",
        extraKeys: ["ExtraCDR"],
        suffix: "%",
        formatter: function(val) {
            // ä¸Šé™40%
            return Math.min(val, 40).toFixed(1);
        }
    }
];
```

### é‡è½½è„šæœ¬

```
/yritems reload
```

**æ— éœ€é‡å¯æœåŠ¡å™¨ï¼**

## ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### ä¼˜ç‚¹

1. **èŒè´£åˆ†ç¦»**
   - Javaè´Ÿè´£åº•å±‚é’©å­ï¼ˆASMã€æ•°æ®åŒ…ï¼‰
   - JavaScriptè´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼ˆæ˜¾ç¤ºè§„åˆ™ï¼‰

2. **çƒ­é‡è½½**
   - ä¿®æ”¹æ˜¾ç¤ºè§„åˆ™æ— éœ€é‡å¯æœåŠ¡å™¨
   - é™ä½è°ƒè¯•æˆæœ¬

3. **å¯æ‰©å±•**
   - æ·»åŠ æ–°å±æ€§åªéœ€ä¿®æ”¹JSé…ç½®
   - æ— éœ€é‡æ–°ç¼–è¯‘æ’ä»¶

4. **æ€§èƒ½**
   - ASMæ³¨å…¥å¤„ç†é«˜é¢‘æ“ä½œï¼ˆç‰©å“åºåˆ—åŒ–ï¼‰
   - JavaScriptå¤„ç†ä½é¢‘æ“ä½œï¼ˆæ•°æ®åŒ…å‘é€ï¼‰
   - Loreç¼“å­˜å‡å°‘é‡å¤è®¡ç®—

### æƒè¡¡

- **å¤æ‚æ€§**ï¼šåŒè¯­è¨€å¼€å‘éœ€è¦ç†è§£ä¸¤ä¸ªå±‚æ¬¡
- **è°ƒè¯•**ï¼šJavaScripté”™è¯¯å †æ ˆè¾ƒéš¾è¿½è¸ª
- **æ€§èƒ½**ï¼šJavaScriptæ¯”Javaæ…¢ï¼Œä½†å¯¹äºLoreç”Ÿæˆæ¥è¯´å¯æ¥å—

## API æš´éœ²ç»™è„šæœ¬

### å…¨å±€å¯¹è±¡

```javascript
plugin          // YRItemsæ’ä»¶å®ä¾‹
Server          // NukkitæœåŠ¡å™¨å®ä¾‹
Packages        // JavaåŒ…è®¿é—®
print(...)      // æ—¥å¿—è¾“å‡ºå‡½æ•°
```

### å¸¸ç”¨ç±»å¿«æ·è®¿é—®

```javascript
Item            // cn.nukkit.item.Item
Player          // cn.nukkit.Player
CompoundTag     // cn.nukkit.nbt.tag.CompoundTag
```

### è°ƒç”¨Javaæ–¹æ³•

```javascript
// é€šè¿‡Packagesè®¿é—®ä»»ä½•Javaç±»
var ItemStack = Packages.cn.nukkit.item.Item;
var item = ItemStack.get(276);  // é’»çŸ³å‰‘

// è°ƒç”¨å®ä¾‹æ–¹æ³•
item.setCustomName("Â§6ä¼ è¯´ä¹‹å‰‘");
```

## æ€»ç»“

YRItems çš„æ¶æ„æ˜¯ï¼š

- âœ… **Javaæä¾›é’©å­**ï¼šASMæ³¨å…¥ã€æ•°æ®åŒ…ç›‘å¬ã€è„šæœ¬å¼•æ“
- âœ… **JavaScriptæ§åˆ¶ä¸šåŠ¡**ï¼šæ˜¾ç¤ºè§„åˆ™ã€Loreç”Ÿæˆã€æ ·å¼å®šåˆ¶
- âœ… **å®Œå…¨å¯æ‰©å±•**ï¼šé€šè¿‡ä¿®æ”¹JSé…ç½®æ·»åŠ æ–°è§„åˆ™
- âœ… **æ”¯æŒçƒ­é‡è½½**ï¼šä¿®æ”¹è„šæœ¬å `/yritems reload` ç«‹å³ç”Ÿæ•ˆ

**ç°åœ¨å·²ç»æ˜¯ä½ æƒ³è¦çš„æ¶æ„äº†ï¼** ğŸ‰
